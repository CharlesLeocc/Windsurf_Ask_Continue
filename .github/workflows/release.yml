# ============================================================
# GitHub Actions å·¥ä½œæµï¼šè‡ªåŠ¨æ‰“åŒ… VSIX å¹¶å‘å¸ƒ Release
# ============================================================
# è§¦å‘æ¡ä»¶ï¼šæ¨é€ v* æ ¼å¼çš„ tagï¼ˆå¦‚ v1.3.2ï¼‰
# åŠŸèƒ½ï¼š
#   1. å®‰è£…ä¾èµ–å¹¶ç¼–è¯‘ TypeScript
#   2. æ‰“åŒ…ç”Ÿæˆ VSIX æ–‡ä»¶
#   3. åˆ›å»º GitHub Release å¹¶ä¸Šä¼  VSIX
# ============================================================

name: å‘å¸ƒ Release

on:
  push:
    tags:
      - 'v*'  # åŒ¹é… v1.0.0, v1.3.1 ç­‰æ ¼å¼çš„ tag

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»º Release
    
    steps:
      # ========== æ­¥éª¤ 1ï¼šæ£€å‡ºä»£ç  ==========
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      # ========== æ­¥éª¤ 2ï¼šè®¾ç½® Node.js ç¯å¢ƒ ==========
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      # ========== æ­¥éª¤ 3ï¼šå®‰è£…ä¾èµ– ==========
      - name: å®‰è£…ä¾èµ–
        run: npm ci
      
      # ========== æ­¥éª¤ 4ï¼šç¼–è¯‘ TypeScript ==========
      - name: ç¼–è¯‘ TypeScript
        run: npm run compile
      
      # ========== æ­¥éª¤ 5ï¼šå®‰è£… vsce æ‰“åŒ…å·¥å…· ==========
      - name: å®‰è£… vsce
        run: npm install -g @vscode/vsce
      
      # ========== æ­¥éª¤ 6ï¼šæ‰“åŒ… VSIX ==========
      - name: æ‰“åŒ… VSIX
        run: vsce package --no-dependencies
      
      # ========== æ­¥éª¤ 7ï¼šè·å–ç‰ˆæœ¬å· ==========
      - name: è·å–ç‰ˆæœ¬å·
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ç‰ˆæœ¬å·: $VERSION"
      
      # ========== æ­¥éª¤ 8ï¼šåˆ›å»º Release å¹¶ä¸Šä¼  VSIX ==========
      - name: åˆ›å»º Release
        uses: softprops/action-gh-release@v1
        with:
          name: "v${{ steps.get_version.outputs.version }} - Windsurf å¯¹è¯å¢å¼ºå·¥å…·"
          body: |
            ## ğŸš€ Windsurf å¯¹è¯å¢å¼ºå·¥å…· v${{ steps.get_version.outputs.version }}
            
            ### ğŸ“¦ å®‰è£…æ–¹å¼
            1. ä¸‹è½½ä¸‹æ–¹çš„ `.vsix` æ–‡ä»¶
            2. åœ¨ Windsurf ä¸­æŒ‰ `Ctrl+Shift+P`ï¼ˆMac: `Cmd+Shift+P`ï¼‰
            3. è¾“å…¥ `Extensions: Install from VSIX`
            4. é€‰æ‹©ä¸‹è½½çš„ VSIX æ–‡ä»¶
            
            ### ğŸ“ æ›´æ–°å†…å®¹
            è¯·æŸ¥çœ‹ [README.md](https://github.com/${{ github.repository }}/blob/main/README.md#-æ›´æ–°æ—¥å¿—) ä¸­çš„æ›´æ–°æ—¥å¿—ã€‚
            
            ---
            
            **â­ å¦‚æœè§‰å¾—å¥½ç”¨ï¼Œè¯·ç»™ä¸ª Star æ”¯æŒä¸€ä¸‹ï¼**
          files: |
            *.vsix
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
